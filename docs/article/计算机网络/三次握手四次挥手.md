## 三次握手 四次挥手

### 三次握手策略：

> 三次握手策略是为了确认双方的发送和接受能力，从而保证 TCP 连接的可靠性。

刚开始客户端是 **`closed`** 状态，服务器端是 **`listen`** 状态。

**第一次握手：** 客户端向服务器端发送一个 **`SYN`** 包，并进入 **`SYN_SEND`** 状态。

**第二次握手：** 服务器端接收到 **`SYN`** 包，回复一个自己的 **`SYN`** 包以及 **`ACK`** 包（客户端的 SYN+1 ），并进入 **`SYN_RECV`**。

**第三次握手：** 客户端接收到 **`SYN + ACK`** 包，回复一个 **`ACK`** 包（服务器端的 SYN+1），并进入 **`establised`** 状态。

**最后：** 服务器端接收到 **`ACK`** 包，进入 **`establised`**，至此，三次握手完成，TCP 连接建立。

![](/images/NetWork/三次握手.png)

### 四次挥手：

+ 假设客户端先发起断开连接请求：

**第一次挥手：** 客户端向服务器端 发送一个 **`FIN`** 包，并进入 **`FIN_WAIT1`** 状态。

**第二次挥手：** 服务器端接收到 **`FIN`** 包，回复一个 **`ACK`** 包（客户端的 FIN+1），并进入 **`CLOSE_WAIT`** 状态。

> 👆 此时需要等待被动断开连接的那一方数据发送完毕（这里是服务器端）。

**第三次挥手：** 服务器端发送一个 **`FIN`** 包，并进入 **`LAST_ACK`** 状态。

**第四次挥手：** 客户端接收到 **`FIN`** 包，返回一个 **`ACK`** 包（服务器端的 FIN+1），并进入 **`TIME_WAIT`** 状态。

**最后：** 服务器端收到 **`ACK`** 包，关闭连接。

![](/images/NetWork/四次挥手.png)

+ **第四次挥手时客户端进入 TIME_WAIT 状态而不是直接 CLOSE 状态的原因：**

因为客户端必须确认服务器端已经接收到了 ACK 包，如果服务器端没有收到 ACK 包，就会在发送一次 FIN 包过来。
然后客户端就知道之前的 ACK 包丢失了，就会重新发送一个 ACK 包。
TIME_WAIT 的持续时间至少是一个报文的来回时间，如果超过了这个时间就进入 CLOSE 状态。
