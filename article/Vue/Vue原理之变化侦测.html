<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue 原理之变化侦测 | 特辣的博客</title>
    <meta name="description" content="Step by step">
    
    
    <link rel="preload" href="/assets/css/0.styles.98303e98.css" as="style"><link rel="preload" href="/assets/js/app.9bc466e0.js" as="script"><link rel="preload" href="/assets/js/2.bc0da09f.js" as="script"><link rel="preload" href="/assets/js/4.6c23dc08.js" as="script"><link rel="prefetch" href="/assets/js/10.7f9b2c60.js"><link rel="prefetch" href="/assets/js/11.b7ec9672.js"><link rel="prefetch" href="/assets/js/12.44e7cb04.js"><link rel="prefetch" href="/assets/js/13.c977ea8f.js"><link rel="prefetch" href="/assets/js/14.3ca8fada.js"><link rel="prefetch" href="/assets/js/15.49fb8b22.js"><link rel="prefetch" href="/assets/js/16.f77d8666.js"><link rel="prefetch" href="/assets/js/17.793a78ce.js"><link rel="prefetch" href="/assets/js/18.e720ae74.js"><link rel="prefetch" href="/assets/js/19.b7f857dc.js"><link rel="prefetch" href="/assets/js/20.20a62293.js"><link rel="prefetch" href="/assets/js/21.04f12faf.js"><link rel="prefetch" href="/assets/js/22.dfdf7735.js"><link rel="prefetch" href="/assets/js/23.9b43db7d.js"><link rel="prefetch" href="/assets/js/24.c06fb8e6.js"><link rel="prefetch" href="/assets/js/25.95bb47b2.js"><link rel="prefetch" href="/assets/js/26.6396c0d9.js"><link rel="prefetch" href="/assets/js/27.ae927678.js"><link rel="prefetch" href="/assets/js/28.1fb3c5c9.js"><link rel="prefetch" href="/assets/js/29.990fdc34.js"><link rel="prefetch" href="/assets/js/3.62dac171.js"><link rel="prefetch" href="/assets/js/30.53047d86.js"><link rel="prefetch" href="/assets/js/31.71fcf53c.js"><link rel="prefetch" href="/assets/js/32.9f8fcea9.js"><link rel="prefetch" href="/assets/js/33.75bbec8e.js"><link rel="prefetch" href="/assets/js/34.1fa01da7.js"><link rel="prefetch" href="/assets/js/35.10349e7e.js"><link rel="prefetch" href="/assets/js/36.3d117ae6.js"><link rel="prefetch" href="/assets/js/37.b4bf6da0.js"><link rel="prefetch" href="/assets/js/38.5b279f27.js"><link rel="prefetch" href="/assets/js/39.a98c8a8e.js"><link rel="prefetch" href="/assets/js/40.47d6e933.js"><link rel="prefetch" href="/assets/js/41.62ed983b.js"><link rel="prefetch" href="/assets/js/42.62a3fbfa.js"><link rel="prefetch" href="/assets/js/5.6ad3abc9.js"><link rel="prefetch" href="/assets/js/6.cdcc581a.js"><link rel="prefetch" href="/assets/js/7.d57a0c3f.js"><link rel="prefetch" href="/assets/js/8.cc13f77a.js"><link rel="prefetch" href="/assets/js/9.c7fc3fdb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.98303e98.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">特辣的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/KangChangYi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://kangchangyi.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/KangChangYi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://kangchangyi.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/article/Vue/Vue原理之变化侦测.html" class="active sidebar-link">Vue 原理之变化侦测</a></li><li><a href="/article/Vue/Vue最佳实践_风格规范整理.html" class="sidebar-link">Vue 框架使用时需注意的风格规范及最佳实践</a></li><li><a href="/article/Vue/基于vue-skeleton-webpack-plugin的骨架屏实战.html" class="sidebar-link">基于 vue-skeleton-webpack-plugin 的骨架屏实战</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>快速查阅</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务端入门ing</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>每月总结</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="vue-原理之变化侦测"><a href="#vue-原理之变化侦测" aria-hidden="true" class="header-anchor">#</a> Vue 原理之变化侦测</h2> <blockquote><p>本篇整理自《深入浅出Vue.js》</p></blockquote> <blockquote><p>更新时间：2020/3/21 14:51</p></blockquote> <h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <p>本文是第一篇对书中 <strong>Vue</strong> 原理的浓缩整理，我看完这本书是在一月份，而现在已经三月底了，我拖了还是真挺久的，不去看看月总结还真不知道我干了什么😑。</p> <p>前端技术发展至今天，<strong>Vue</strong> 及 <strong>React</strong> 已经成为前端工程师的必备技能，新的框架极大的提高了我们的开发效率，并且很容易学习。</p> <p>我有一句印象很深的话，是这么说的：<em>“学习新技术的同时，要更多的关注和了解它的原理，而不仅仅是用法。你每了解一个它的原理，就像是打下了一个桩，这些桩最终会关联在一起，它会在你看源码时起到非常大的作用。”</em></p> <p>在使用 <strong>Vue</strong> 开发项目的时候，大家都会遇到一些奇奇怪怪的问题，而能否快速解决这些问题，并理解这些问题为什么会发生，主要取决于对 <strong>Vue</strong> 原理的理解是否足够深入。</p> <p>将学习原理成为一种习惯是我对自己的一点要求，自知记性不好但别把这点忘了💾。</p> <h2 id="object-的变化侦测"><a href="#object-的变化侦测" aria-hidden="true" class="header-anchor">#</a> Object 的变化侦测</h2> <p><strong>Object</strong> 和 <strong>Array</strong> 的变化侦测在 <strong>Vue</strong> 中采用的不同的处理方式，具体原因在讲 <strong>Array</strong> 时就知道了。</p> <h3 id="_1-1-什么是变化侦测"><a href="#_1-1-什么是变化侦测" aria-hidden="true" class="header-anchor">#</a> 1.1 什么是变化侦测</h3> <p>简单来说，变化侦测，就是侦测数据的变化，当数据变化时，通知视图进行相应的更新。</p> <p>通常来说，应用在运行时内部的状态会不断的变化，此时就需要不停的渲染，那 <strong>Vue</strong> 是如何确定状态中发生了什么变化的？它又是通过什么侦测变化的？</p> <p>带着问题接着仔细往下看👇。</p> <h3 id="_1-2-如何追踪变化"><a href="#_1-2-如何追踪变化" aria-hidden="true" class="header-anchor">#</a> 1.2 如何追踪变化</h3> <p>学前端的人都知道，在 Javascript 中，有两种方法可以侦测到一个对象的变化：</p> <ul><li><strong>Object.defineProperty</strong></li> <li><strong>Proxy</strong></li></ul> <p>由于 ES6 在浏览器中的支持并不理想，而 Proxy 又无法 polyfill，所以 Vue 2.x 采用了 <code>Object.defineProperty</code> 方法来实现的变化侦测。</p> <blockquote><p>题外话：由于使用 <strong>Object.defineProperty</strong> 侦测变化存在较多的缺陷 ，所以尤在 Vue 3.x 版本使用了 Proxy 重写了以前的变化侦测。</p></blockquote> <p>那么知道了 <code>Object.defineProperty</code> 可以侦测对象的变化，那么我们就可以写出如下的代码：</p> <img src="/images/Vue变化侦测/defineProperty.png" width="500"> <p>我们封装 <code>Object.defineProperty</code>，通过使用 <code>defineReactive</code> 函数，侦测一个对象属性的变化，每当从 <code>data</code> 的 <code>key</code> 中读取数据时，会触发 <code>getter</code>，每当为 <code>data</code> 的 <code>key</code> 赋值时，会触发 <code>setter</code>。</p> <h3 id="_1-3-如何收集依赖"><a href="#_1-3-如何收集依赖" aria-hidden="true" class="header-anchor">#</a> 1.3 如何收集依赖</h3> <p>现在，我们已经能够侦测到状态的读写变化了。</p> <p>接着思考一下，我们之所以要观察数据的变化，其实目的是为了在数据发生变化的时候，向使用了它的地方发送通知，让它更新。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>举一个例子，上面的模板中使用了 <code>title</code>，那么当它发生变化时，就要向使用了它的地方发送通知。在这里，我们将使用了 <code>title</code> 的地方称之为 <code>title</code> 的<span class="important-font"> 依赖</span>。</p> <p><span class="important-font">🎯所以，当状态发生变化时，我们为了通知依赖进行更新，就需要将依赖收集起来。</span></p> <p>而 <code>Object.defineProperty</code> 真正有用的就是收集依赖，那么如何收集依赖？</p> <p>这个问题，总结起来就一句话：🎯<span class="important-font">在 getter 中收集依赖，在 setter 中触发依赖。</span></p> <img src="/images/Vue变化侦测/dep1.png" width="400"> <p><span class="important-font">Vue 通过给状态绑定依赖，在状态变化时，通知该状态的每一个依赖进行更新操作。</span></p> <ul><li><p>在 <strong>React</strong> 中，当状态变化时，它不知道是哪个状态发生了变化，只知道状态变了，所以进行暴力对比来找出哪些 DOM 节点更新了，需要重新渲染。</p></li> <li><p>而在 <strong>Vue</strong> 中，当状态变化时，<strong>Vue</strong> 立刻就知道了，并且在一定程度上知道是哪一个状态发生了变化，知道的信息更多，也就可以进行更细粒度的更新操作。</p></li></ul> <p>其中在 <strong>Vue 2.0</strong> 以前，依赖的细粒度为 DOM 节点，这使得依赖的数量非常多，使得内存也占用较多。</p> <p>而在 <strong>Vue 2.0</strong> 之后，依赖的细粒度更改为了组件大小，大大降低的依赖数量，在状态变化时，通知到的具体的组件，在由组件内部使用虚拟 DOM 进行重新渲染。</p> <h3 id="_1-4-依赖收集在哪里"><a href="#_1-4-依赖收集在哪里" aria-hidden="true" class="header-anchor">#</a> 1.4 依赖收集在哪里</h3> <p>现在我们有了明确的目标，就是收集依赖，那么依赖收集在哪呢？</p> <p>思考一下，首先想到的就是每个状态都有一个数组，用来存储该状态的依赖，<strong>Vue</strong> 把依赖收集的代码封装成了 <code>Dep</code> 类，专门用来管理依赖。</p> <img src="/images/Vue变化侦测/depend.png" width="500"> <p>修改了一下 <code>defineReactive</code> 函数，新增一个 <code>Dep</code> 类，我们使用这个类，在状态被读取（触发 getter）的时候收集依赖，在状态被修改（触发 setter）的时候通知依赖进行更新。</p> <p>也就是上面说的，在 <code>getter</code> 中收集依赖，在 <code>setter</code> 中触发依赖。</p> <p>顺便也回答了上面的问题，依赖收集到哪？收集到 <code>Dep</code> 中。</p> <p><code>Dep</code> 类的源码这里就我不整理出来了。</p> <h3 id="_1-5-依赖是谁"><a href="#_1-5-依赖是谁" aria-hidden="true" class="header-anchor">#</a> 1.5 依赖是谁</h3> <p>依赖说来说去也整了半天，它到底是什么？我们要收集谁呢？</p> <p>收集谁，换句话说，就是状态变化后，通知谁。</p> <p>在状态更新时，我们需要通知使用到这个状态的地方，而这个地方有很多，有可能是模板，也有可能是 <code>watch</code>。</p> <p><strong>Vue</strong> 抽象出了一个依赖类，并且在依赖收集阶段只收集这个类的实例到 <code>Dep</code> 中，那么这个抽象的东西需要一个名字，它叫什么？嗯，就叫<code>Watcher</code> 吧（订阅者）。</p> <p><code>Watcher</code> 的源码也不在这里整理出来了，相关源码涉及的有点多，后续再开另外一篇用来分析源码吧。Mark💾</p> <h3 id="_1-6-递归侦测所有-key"><a href="#_1-6-递归侦测所有-key" aria-hidden="true" class="header-anchor">#</a> 1.6 递归侦测所有 key</h3> <p>在前面，我们知道了如何进行变化侦测，但是前面的代码只能侦测数据中的某一个属性，而我们希望把数据中的所有属性都侦测到。</p> <img src="/images/Vue变化侦测/observer2.png" width="200"> <p><strong>Vue</strong> 封装了一个 <code>Observer</code> 类（发布者），这个类的作用就是将一个对象内的所有属性都转换为 <code>getter/setter</code> 的形式（都侦测一遍），追踪它们的变化。</p> <img src="/images/Vue变化侦测/observer1.png" width="300"> <p>当状态经过 <code>Observer</code> 类转换过之后，当其中的属性发生变化，对应的依赖就会收到通知。</p> <p>同样的 <code>Observer</code> 类的源码不在这里整理出来了。</p> <blockquote><p>有两个名词，<strong>订阅者</strong> 和 <strong>发布者</strong>，解释一下：Vue 的响应式原理是结合了 <strong>数据侦测</strong> 以及设计模式中的 <strong>订阅/发布者模式</strong> 实现的。</p></blockquote> <h3 id="_1-7-关于-object-无法侦测的操作"><a href="#_1-7-关于-object-无法侦测的操作" aria-hidden="true" class="header-anchor">#</a> 1.7 关于 Object 无法侦测的操作</h3> <p>前面介绍的是 <strong>Object</strong> 类型数据的变化侦测原理，了解了数据变化是通过 <code>getter/setter</code> 来追踪的。也正是因为这一追踪方式，有些语法对数据的操作 <strong>Vue</strong> 无法追踪到。</p> <p>比如：</p> <ul><li>为一个对象新增本没有的属性。</li></ul> <img src="/images/Vue变化侦测/cantObserver1.png" width="350"> <p>和：</p> <ul><li>使用 <code>delete</code> 关键字删除对象属性。</li></ul> <img src="/images/Vue变化侦测/cantObserver2.png" width="350"> <p>由于这两个操作无法触发 <code>getter/setter</code>，所以 <strong>Vue</strong> 不会向依赖发送通知，视图也就无法更新。</p> <p>因为 <code>Object.defineProperty</code> 只能追踪到一个数据是否被修改，无法追踪新增属性和删除属性，这也是没有办法的事情，这就是使用 <code>Object.defineProperty</code> 实现变化侦测的缺陷之一。</p> <p>为了解决这个问题 <strong>Vue</strong> 提供了两个 API，<code>vm.$set</code> 和 <code>vm.$delete</code>，后续整理内容会有介绍。</p> <p>To be Continue...</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/article/JavaScript/你不知道的JavaScript下卷（二）.html" class="prev">
          你不知道的 JavaScript 下卷知识点整理（二）
        </a></span> <span class="next"><a href="/article/Vue/Vue最佳实践_风格规范整理.html">
          Vue 框架使用时需注意的风格规范及最佳实践
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9bc466e0.js" defer></script><script src="/assets/js/2.bc0da09f.js" defer></script><script src="/assets/js/4.6c23dc08.js" defer></script>
  </body>
</html>
